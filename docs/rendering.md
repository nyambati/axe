# Team-Based Alertmanager Configurations

This guide explains how to use Axe CLI to manage and generate Alertmanager configurations from multiple team-specific files.

## Table of Contents

- [Directory Structure](#directory-structure)
- [Base Configuration](#base-configuration)
- [Team-Specific Configurations](#team-specific-configurations)
- [Generating the Final Configuration](#generating-the-final-configuration)
- [Validation and Error Handling](#validation-and-error-handling)
- [Example Workflow](#example-workflow)

## Directory Structure

Axe expects the following directory structure:

```console
.
├── alertmanager.yaml # The final configuration file auto generated by Axe
├── base.yaml # The base configuration file
├── observability
│   └── config.yaml # Team specific configuration file
└── release
│   └── config.yaml # Team specific configuration file
└── templates
    └── alerts.tmpl # Alert templates
```

## Base Configuration

The `base.yaml` file contains the global Alertmanager configuration and acts as the foundation. It should include:

- Global configuration
- Default route
- Common receivers
- Any global templates

Example `base.yaml`:

```yaml
global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/...'

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h
  receiver: 'default-receiver'
  routes: []  # Will be populated from team files

receivers:
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://alertmanager-webhook:5001/'

templates:
  - 'templates/*.tmpl'
```

## Team-Specific Configurations

### Route and Receiver Configuration

Each team should create a YAML file in the `team_name/` directory. These files should contain routing configurations that will be merged into the base configuration. this includes routes and recievers. the yaml file name can be anything.

Example  observability team config `observability/config.yaml`:

```yaml
receivers:
  - name: 'observability-pager'
    webhook_configs:
      - url: 'http://alertmanager-webhook:5001/'
routes:
  - receiver: 'observability-pager'
    match:
      team: 'observability'
      severity: 'critical'
    continue: false

```

## Generating the Final Configuration

To generate the final Alertmanager configuration:

```bash
# Basic usage
axe render config/

# Enable verbose output for debugging
axe render config --verbose
```

### How It Works

1. Axe loads the base configuration from `base.yaml`
2. It recursively searches through all subdirectories (except those starting with '_' or '.')
3. For each YAML file found (except `base.yaml` and `alertmanager.yaml`):
   - If the has `routes` key, its contents are appended to the base `routes` list
   - If the has `receivers` key, its contents are merged into the base `receivers` list
   - If the has `time_intervals` key, its contents are merged into the base `time_intervals` list

4. The final file is validated for conflicts and missing receivers defined in routes.

## Validation and Error Handling

Axe performs several validations during the rendering process:

- **Duplicate Receiver Names**: Ensures no duplicate receiver names across all files
- **Route Validation**: Verifies that all routes reference existing receivers
- **Time Interval Validation**: Verifies that all time intervals are valid

If any issues are found, Axe will display detailed error messages:

```console
Error: Duplicate receiver name 'frontend-pager' found in 'config/receivers/team-frontend.yaml' and 'config/receivers/team-other.yaml'
```

## Example Workflow

### Initialize a new configuration

```bash
   mkdir -p config/observability
   touch config/base.yaml
```

### Add team configurations

```bash
   # Add observability team config
   echo 'routes:
   - receiver: observability-pager
     match:
       team: observability
       severity: critical' > config/observability/team-observability.yaml

   echo 'receivers:
   - name: observability-pager
     pagerduty_configs:
     - routing_key: your-pagerduty-key' >> config/observability/team-observability.yaml
```

### Generate the final configuration

```bash
   axe render config
   # View the generated configuration
   cat alertmanager.generated.yaml
```

## Advanced Usage

### Environment Variable Substitution

You can use environment variables in your configuration files:

```yaml
receivers:
  - name: 'slack-webhook'
    slack_configs:
      - api_url: $slack_webhook_url
```

Then pass the environment variable when rendering:

```bash
SLACK_WEBHOOK_URL=https://... axe render config
```
